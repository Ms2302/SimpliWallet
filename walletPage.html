<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalletPage</title>
    <link rel = "stylesheet" href="walletPage.css">

</head>
<body>
    <div class="Title">
        <h4>Wallet Page</h4>
        <br>
        <label for="port">Portfolio Value:    </label>
        <strong id="port"></strong>
        <br>
        <br>
        
    </div>
    <button onclick="reloadPage()">Refresh</button>
   
    <div>
        <table style="width: 100%;"> 
            <tr>
                <th style="width: 50%;">Token</th>
                <th>Quantity</th>
                <th>Value</th>
                <th>Send/Deposit</th>
            </tr>
            <tr style="height: 50px;">
                <td id="eth">ETH</td>
                <td id="ethQuant">Loading....</td>
                <td id="ethPrice"></td>
                <td>
                    <button onclick="openFormEth()" class="EthSend">Send</button>
                    <button onclick=showDeposit() class="EthRecieve">Deposit</button>
                </td>
            </tr>
            <tr style="height: 50px;">
                <td id="LINK">LINK</td>
                <td id="linkQuant">Loading....</td>
                <td id="linkPrice"></td>
                <td>
                    <button onclick="openFormLink()" class="LinkSend">Send</button>
                    <button onclick=showDeposit() class="LinkRecieve">Deposit</button>
                </td>
            </tr>
            <tr style="height: 50px;">
                <td id="BAT">BAT</td>
                <td id="batQuant">Loading....</td>
                <td id="batPrice"></td>
                <td>
                    <button onclick="openFormBAT()"class="BatSend">Send</button>
                    <button onclick=showDeposit() class="BatRecieve">Deposit</button>
                </td>
            </tr>
            <tr style="height: 50px;">
                <td id="REP">REP</td>
                <td id="repQuant">Loading....</td>
                <td id="repPrice"></td>
                <td>
                    <button onclick="openFormREP()" class="RepSend">Send</button>
                    <button onclick=showDeposit() class="RepRecieve">Deposit</button>
                </td>
            </tr>
        </table>



        
      
    </div>


    <div id= "sendEth" class="alert" style="display: none;">
        <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span> 
        <div style="display: inline-block;">
            <strong>Send Tokens to this address:</strong> <p id="currentseed"></p>
            <button id = "copyButton" onclick="copyText()">Copy Address</button>
        </div>
      </div>

    
    

      <div class="form-popup" id="ethSend">
        <div class="form-container">
          <h1>Send Eth</h1>
      
          <label for="Address"><b>Enter Address</b></label>
          <input id="AddressSendEth" type="text" placeholder="Enter Address" name="Address" required>
      
          <label for="Quantity"><b>Quantity</b></label>
          <input id= "QuantSendEth" type="text" placeholder="Enter Quantity" name="Quantity" required>
      
          <button type="submit" class="btn" onclick="sendFormEth()">Send</button>
          <button type="button" class="btn cancel" onclick="closeFormEth()">Cancel</button>
        </div>
      </div>


      <div class="form-popup" id="linkSend">
        <div class="form-container">
          <h1>Send Link</h1>
      
          <label for="Address"><b>Enter Address</b></label>
          <input id="AddressSendLink" type="text" placeholder="Enter Address" name="Address" required>
      
          <label for="Quantity"><b>Quantity</b></label>
          <input id= "QuantSendLink" type="text" placeholder="Enter Quantity" name="Quantity" required>
      
          <button type="submit" class="btn" onclick="sendFormLink()">Send</button>
          <button type="button" class="btn cancel" onclick="closeFormLink()">Cancel</button>
        </div>
      </div>
      
      <div class="form-popup" id="batSend">
        <div class="form-container">
          <h1>Send BAT</h1>
      
          <label for="Address"><b>Enter Address</b></label>
          <input id="AddressSendBAT" type="text" placeholder="Enter Address" name="Address" required>
      
          <label for="Quantity"><b>Quantity</b></label>
          <input id= "QuantSendBAT" type="text" placeholder="Enter Quantity" name="Quantity" required>
      
          <button type="submit" class="btn" onclick="sendFormBAT()">Send</button>
          <button type="button" class="btn cancel" onclick="closeFormBAT()">Cancel</button>
        </div>
      </div>

      <div class="form-popup" id="repSend">
        <div class="form-container">
          <h1>Send REP</h1>
      
          <label for="Address"><b>Enter Address</b></label>
          <input id="AddressSendREP" type="text" placeholder="Enter Address" name="Address" required>
      
          <label for="Quantity"><b>Quantity</b></label>
          <input id= "QuantSendREP" type="text" placeholder="Enter Quantity" name="Quantity" required>
      
          <button type="submit" class="btn" onclick="sendFormREP()">Send</button>
          <button type="button" class="btn cancel" onclick="closeFormREP()">Cancel</button>
        </div>
      </div>











    <script>
        const { ipcRenderer } = require('electron');
        const fs = require("fs")
        const currentSeed = fs.readFileSync("CurrentSeed.txt","utf-8").trim();
        
        console.log(currentSeed)
        console.log(typeof(currentSeed))


        const {MongoClient} = require('mongodb');

        async function findUserBySeed(client,seedPhrase){
            const result = await client.db("WalletUsers").collection("UserValues").findOne({seed: seedPhrase})
            if (result){
                console.log(`Found a user with the seed phrase '${seedPhrase}'`);
                console.log(result)
                fs.writeFileSync("CurrentQuants.txt",result['EthQuant']+"\r\n");
                fs.appendFileSync("CurrentQuants.txt",result['LinkQuant'] + "\r\n");
                fs.appendFileSync("CurrentQuants.txt",result['BatQuant'] + "\r\n");
                fs.appendFileSync("CurrentQuants.txt",result['RepQuant'] + "\r\n");
            }else{
               console.log(`No user found with the seed '${seedPhrase}'`); 
            }
        }

        
        async function main(currentSeed) {
        const uri = "mongodb+srv://guacamole:Stpeters565@cluster0.l6stk.mongodb.net/myFirstDatabase?retryWrites=true&w=majority"
  
        const client = new MongoClient(uri);
        try{
            await client.connect();
            await findUserBySeed(client,currentSeed)
        } catch(e){
            console.error(e);
        } finally{
            await client.close()
        }
        }

        async function reloadPage(){
            const uri = "mongodb+srv://guacamole:Stpeters565@cluster0.l6stk.mongodb.net/myFirstDatabase?retryWrites=true&w=majority"
            const client = new MongoClient(uri);
            reload(client)
        }

        async function reload(client){
            await client.connect()
            await findUserBySeed(client,currentSeed)
            window.location.reload()
            console.log("reloaded")
        }
      
        function openFormEth() {
             document.getElementById("ethSend").style.display = "block";
        }

        function openFormLink() {
             document.getElementById("linkSend").style.display = "block";
        }
        function openFormBAT() {
             document.getElementById("batSend").style.display = "block";
        }
        function openFormREP() {
             document.getElementById("repSend").style.display = "block";
        }

        function closeFormEth() {
             document.getElementById("ethSend").style.display = "none";
        }

        function closeFormLink() {
             document.getElementById("linkSend").style.display = "none";
        }
        function closeFormBAT() {
             document.getElementById("batSend").style.display = "none";
        }
        function closeFormREP() {
             document.getElementById("repSend").style.display = "none";
        }

        function sendFormEth() {

        document.getElementById("ethSend").style.display = "none";
        const uri = "mongodb+srv://guacamole:Stpeters565@cluster0.l6stk.mongodb.net/myFirstDatabase?retryWrites=true&w=majority"
        const client = new MongoClient(uri);
        
        const address = document.getElementById("AddressSendEth").value;
        console.log(address)
        const quant = parseInt(document.getElementById("QuantSendEth").value);


        async function updateEth(client,address,updatedEth){
          
            await client.connect()
            const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedEth});
            console.log(`${result.matchedCount} document(s) matched the query criteria`);
            console.log(`${result.modifiedCount} documents was/were updated`);
        }

        async function updateEthCurrent(client,address,updatedEth){
          
          await client.connect()
          const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedEth});
          console.log(`${result.matchedCount} document(s) matched the query criteria`);
          console.log(`${result.modifiedCount} documents was/were updated`);
      }


        updateEth(client,address,{EthQuant:quant})
        const negative = 0 - quant;
        console.log(negative)
        updateEthCurrent(client,currentSeed,{EthQuant:negative})
        reload(client)
        }



        function sendFormLink() {

            document.getElementById("linkSend").style.display = "none";
            const uri = "mongodb+srv://guacamole:Stpeters565@cluster0.l6stk.mongodb.net/myFirstDatabase?retryWrites=true&w=majority"
            const client = new MongoClient(uri);

            const address = document.getElementById("AddressSendLink").value;
            console.log(address)
            const quant = parseInt(document.getElementById("QuantSendLink").value);


            async function updateLink(client,address,updatedLink){
            
                await client.connect()
                const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedLink});
                console.log(`${result.matchedCount} document(s) matched the query criteria`);
                console.log(`${result.modifiedCount} documents was/were updated`);
            }

            async function updateLinkCurrent(client,address,updatedLink){
            
            await client.connect()
            const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedLink});
            console.log(`${result.matchedCount} document(s) matched the query criteria`);
            console.log(`${result.modifiedCount} documents was/were updated`);
            }


            updateLink(client,address,{LinkQuant:quant})
            const negative = 0 - quant;
            console.log(negative)
            updateLinkCurrent(client,currentSeed,{LinkQuant:negative})
            reload(client)
            }






        function sendFormBAT() {

            document.getElementById("batSend").style.display = "none";
            const uri = "mongodb+srv://guacamole:Stpeters565@cluster0.l6stk.mongodb.net/myFirstDatabase?retryWrites=true&w=majority"
            const client = new MongoClient(uri);

            const address = document.getElementById("AddressSendBAT").value;
            console.log(address)
            const quant = parseInt(document.getElementById("QuantSendBAT").value);


            async function updateBAT(client,address,updatedBAT){

                await client.connect()
                const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedBAT});
                console.log(`${result.matchedCount} document(s) matched the query criteria`);
                console.log(`${result.modifiedCount} documents was/were updated`);
            }

            async function updateBATCurrent(client,address,updatedBAT){

            await client.connect()
            const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedBAT});
            console.log(`${result.matchedCount} document(s) matched the query criteria`);
            console.log(`${result.modifiedCount} documents was/were updated`);
            }


            updateBAT(client,address,{BatQuant:quant})
            const negative = 0 - quant;
            console.log(negative)
            updateBATCurrent(client,currentSeed,{BatQuant:negative})
            reload(client)
            }


            
        function sendFormREP() {

            document.getElementById("repSend").style.display = "none";
            const uri = "mongodb+srv://guacamole:Stpeters565@cluster0.l6stk.mongodb.net/myFirstDatabase?retryWrites=true&w=majority"
            const client = new MongoClient(uri);

            const address = document.getElementById("AddressSendREP").value;
            console.log(address)
            const quant = parseInt(document.getElementById("QuantSendREP").value);


            async function updateREP(client,address,updatedREP){

                await client.connect()
                const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedREP});
                console.log(`${result.matchedCount} document(s) matched the query criteria`);
                console.log(`${result.modifiedCount} documents was/were updated`);
            }

            async function updateREPCurrent(client,address,updatedREP){

            await client.connect()
            const result = await client.db("WalletUsers").collection("UserValues").updateOne({seed: address},{$inc: updatedREP});
            console.log(`${result.matchedCount} document(s) matched the query criteria`);
            console.log(`${result.modifiedCount} documents was/were updated`);
            }


            updateREP(client,address,{RepQuant:quant})
            const negative = 0 - quant;
            console.log(negative)
            updateREPCurrent(client,currentSeed,{RepQuant:negative})
            reload(client)
            }







        function showDeposit(){
            document.getElementById('sendEth').style.display = 'block'
            document.getElementById('currentseed').innerHTML = currentSeed
            document.getElementById('copyButton').innerHTML = "Copy Address"

        }
        function copyText() {
            var copyText = document.getElementById("currentseed").innerHTML;
            navigator.clipboard.writeText(copyText);
            document.getElementById("copyButton").innerHTML = "Copied!"
        }

       
        

        
        
        async function values(){
        await main(currentSeed)
        const quants = fs.readFileSync('CurrentQuants.txt','utf-8') 
        const data = fs.readFileSync('Prices.txt','utf-8') 
        
        const quant = quants.split("\n") 
        var priceByLine = data.split("\n")


        document.getElementById("ethQuant").innerHTML = quant[0]
        var temp2 = parseInt(document.getElementById("ethQuant").innerHTML)
        ethValue = parseInt(priceByLine[0])*temp2
        document.getElementById("ethPrice").innerHTML = "£" + (priceByLine[0]*temp2).toFixed(2);

       
        document.getElementById("linkQuant").innerHTML = quant[1]
        var temp3 = parseInt(document.getElementById("linkQuant").innerHTML)
        linkValue = parseInt(priceByLine[1])*temp3
        document.getElementById("linkPrice").innerHTML = "£" + (priceByLine[1]*temp3).toFixed(2);


        document.getElementById("batQuant").innerHTML = quant[2]
        var temp4 = parseInt(document.getElementById("batQuant").innerHTML)
        batValue = parseInt(priceByLine[2])*temp4
        document.getElementById("batPrice").innerHTML = "£" + (priceByLine[2]*temp4).toFixed(2);

        document.getElementById("repQuant").innerHTML = quant[3]
        var temp5 = parseInt(document.getElementById("repQuant").innerHTML)
        repValue =  parseInt(priceByLine[3])*temp5
        document.getElementById("repPrice").innerHTML = "£" + (priceByLine[3]*temp5).toFixed(2);
        
        console.log(parseInt(ethValue))
        document.getElementById("port").innerHTML = "£" + (parseInt(ethValue)+parseInt(linkValue)+parseInt(batValue)+parseInt(repValue)).toFixed(2)
        }
        values()
        
    </script>
</body>
</html>